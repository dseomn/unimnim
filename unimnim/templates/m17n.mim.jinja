{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: CC0-1.0 OR LGPL-2.1-or-later OR Apache-2.0
-#}

{#- Ignore the next line, feel free to edit this file. -#}
;; Automatically generated by unimnim, do not edit.


(input-method t unimnim)

(description "https://github.com/dseomn/unimnim")

(title "UNIcode MNemonic Input Method {{ version }}")

(variable
  (prompt (_"What to show before a mnemonic") "·")

  (search-prefix-prompt (_"What to show before a mnemonic prefix search") "·")
  )

(command
  (start (_"Start a mnemonic") (A-\\))

  (search-prefix-start (_"Start a search for a mnemonic prefix") (A-\\ A-\\))
  )

(macro
  (delete-prompt (mark CUR) (move PROMPT) (delete @<) (move CUR))
  )

(map
  (starter (start prompt))
  (map
    {%- for prefix in prefix_map if prefix %}
    {%- if prefix in map %}
    ({{ prefix | m17n_mtext }} (delete @<) {{ map[prefix] | m17n_mtext }})
    {%- else %}
    {#-
     # If the user types a prefix of a mnemonic that is not itself a full
     # mnemonic, the pre-edit should be open to keep typing a full mnemonic. If
     # they then type a key that makes the prefix invalid, it should commit and
     # go back to the init state. However, if that key is the first key of any
     # other mnemonic, it would instead start the map again from that point.
     # This makes the map match all prefixes so that (shift init) happens rather
     # than starting the map again.
     #}
    ({{ prefix | m17n_mtext }})
    {%- endif %}
    {%- endfor %}
    )

  (search-prefix-starter (search-prefix-start search-prefix-prompt))
  (search-prefix-map
    {%- for prefix, results in prefix_map.items() if prefix %}
    ({{ prefix | m17n_mtext }}
      (delete @<)
      (
       (
        {%- for result in results %}
        {{ result | m17n_mtext }}
        {%- endfor %}
        )
       )
      (show)
      )
    {%- endfor %}
    )

  (backspace (BackSpace))
  )

; There are two approaches to committing here. Using (shift init) after the
; state's main map causes it to commit as soon as possible. Using (shift
; backspace) gives the user a chance to press backspace within the pre-edit even
; if there are no other letters that could be typed to get a different mnemonic.
(state
  (init
    (starter (mark PROMPT) (shift map))
    (search-prefix-starter (mark PROMPT) (shift search-prefix-map))
    )
  (map
    (map (delete-prompt) (shift init))
    (nil (delete-prompt) (shift init))
    )
  (search-prefix-map
    (search-prefix-map (shift backspace))
    (nil (delete-prompt) (shift init))
    )
  (backspace
    (backspace (undo))
    (nil (delete-prompt) (shift init))
    )
  )
